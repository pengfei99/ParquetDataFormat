---
title: "ArrowTimeStamp.Rmd"
output: html_document
---

```{r}
library(arrow)
```
```{r}
minio <- S3FileSystem$create(
   access_key = Sys.getenv("AWS_ACCESS_KEY_ID"),
   secret_key = Sys.getenv("AWS_SECRET_ACCESS_KEY"),
   session_token = Sys.getenv("AWS_SESSION_TOKEN"),
   scheme = "https",
   endpoint_override = Sys.getenv("AWS_S3_ENDPOINT")
   )
```

# 1. Check the timestamp generated by pyarrow

## 1.1 Read parquet file(format version 1.0) which is generated by pyarrow

```{r}
path_v1 <- "pengfei/diffusion/data_format/timestamp_compability/arrow_time_v1.0/2dd1f2f1caa9440a86ab91282c0df49c.parquet"


df_pyarrow_v1 <- read_parquet(minio$path(path_v1),  as_data_frame = TRUE)
```

You can notice that for the naive time point, the timestamp changes. Because the
naive time point does not have timezone. And the R data.frame convert it 
automatically to the default timezone of the server. 

Note the aware timestamp does not change, because it contains timezone 

```{bash}
# Get the current system timezone
date +"%Z %z"
```


```{r}
head(df_pyarrow_v1)

```
## 1.2 Read the parquet format version 2 generated by pyarrow

It's the same result. It means the parquet format version will not affect the
timestamp conversion between pyarrow and Rarrow.

```{r}
path_v2 <- "pengfei/diffusion/data_format/timestamp_compability/arrow_time_v2.0/69a06a23d40244c8b622b73b1c56ca17.parquet"

df_pyarrow_v2 <- read_parquet(minio$path(path_v2),  as_data_frame = TRUE)

head(df_pyarrow_v2)

```

# 2. Check the timestamp generated by spark

## 2.1 Check the timestamp without timezone

For the spark timestamp, we have three column types:
- string
- long
- timestamp (long in microsecond)

The string column is not impacted as expected. The long column is not impacted 
because it's not considered as timestamp. The timestamp column is automatically
converted. As it's converted by using the default system

```{r}
spark_parquet_utc_v1 <- "pengfei/diffusion/data_format/timestamp_compability/spark_time_v1.0/part-00000-243747a9-7177-4494-940f-39bfc2a18897-c000.snappy.parquet"


df_spark_utc_v1 <- read_parquet(minio$path(spark_parquet_utc_v1),  as_data_frame = TRUE)
```

The timestamp in the parquet file that the df_spark_utc_v1 reads is generated with timezone UTC.
You can noticed the column t1_timestamp, and t2_timestamp shift 1 hour from the correct result.

That's because the timestamp is created with timezone UTC. And the current system timezone of the Rstudio
is CET. 
```{r}
head(df_spark_utc_v1)
```

If we convert the long timestamp by using the UTC timezone, we have the right timestamp

```{r}
t1 <- 2398377600
as.POSIXct(t1, origin="1970-01-01", tz="UTC")
as.POSIXct(t1, origin="1970-01-01", tz="CET")


t2 <- 2398406400
as.POSIXct(t2,origin="1970-01-01",tz="UTC")
as.POSIXct(t2, origin="1970-01-01", tz="CET")

```
As the spark_upc_v1.0 parquet is generated by a spark context with session timezone of US/Pacific.
When R read this parquet file, you can notice the timestap column are automatically converted by using the system
default timezone. And the offset between US/Pacifict and CET is 9 hour.

```{r}
spark_parquet_upc_v1 <- "pengfei/diffusion/data_format/timestamp_compability/spark_time_upc_v1.0/part-00000-11e523a1-0aee-4b02-b30d-4814dfe91180-c000.snappy.parquet"


df_spark_upc_v1 <- read_parquet(minio$path(spark_parquet_upc_v1),  as_data_frame = TRUE)

head(df_spark_upc_v1)

```
```{r}
t1 <- 2398406400
as.POSIXct(t1, origin="1970-01-01", tz="US/Pacific")
as.POSIXct(t1, origin="1970-01-01", tz="CET")


t2 <- 2398435200
as.POSIXct(t2, origin="1970-01-01", tz="US/Pacific")
as.POSIXct(t2, origin="1970-01-01", tz="CET")
```
## 2.2 Check the timestamp with timezone

You can notice the auto conversion for column timestamp are wrong. The reason
is like before
```{r}
spark_parquet_tz_v1 <- "pengfei/diffusion/data_format/timestamp_compability/spark_timestamp_with_timezone_v1.0/part-00000-8cd36253-6cf9-4170-9922-ce9ae89ed157-c000.snappy.parquet"

df_spark_tz_v1 <- read_parquet(minio$path(spark_parquet_tz_v1),  as_data_frame = TRUE)

head(df_spark_tz_v1)
```
Can't cast it to a timestamp correctlly. The timezone offset is never taken into consideration.

```{r}
x <- "2046-01-01 00:15:00+01:00"
strftime(x, format = "%Y-%m-%d %H:%M:%S", tz = "UTC+1")

```

